This is chapter 6 in test branch.